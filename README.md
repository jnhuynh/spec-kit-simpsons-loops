# Simpsons Loops for Speckit + Claude Code

Automated iteration loops for [Speckit](https://github.com/speckit)-powered projects using Claude Code CLI.

- **Ralph Loop** — Task-by-task implementation. Picks up the next incomplete task from `tasks.md`, implements it, validates, commits, and exits. Repeats with fresh context until all tasks are done.
- **Lisa Loop** — Iterative cross-artifact analysis. Runs `/speckit.analyze` on `spec.md`, `plan.md`, and `tasks.md`, fixes all findings at the highest severity level, commits, and exits. Repeats until zero findings remain.

Both loops invoke `claude -p` with a fresh context per iteration, which avoids context window limits and keeps each run focused.

## Prerequisites

- A project already set up with Speckit (`.specify/` directory exists)
- [Claude Code CLI](https://docs.anthropic.com/en/docs/claude-code) installed
- Existing Speckit commands in `.claude/commands/` (at minimum: `speckit.implement.md`, `speckit.analyze.md`)

## Setup

### 1. Copy files into your project

From the root of your project, copy each file to its destination:

```bash
# Shell scripts → .specify/scripts/bash/
cp <path-to-simpsons-loops>/ralph-loop.sh   .specify/scripts/bash/ralph-loop.sh
cp <path-to-simpsons-loops>/lisa-loop.sh     .specify/scripts/bash/lisa-loop.sh

# Prompt templates → .specify/templates/
cp <path-to-simpsons-loops>/ralph-prompt.template.md   .specify/templates/ralph-prompt.template.md
cp <path-to-simpsons-loops>/lisa-prompt.template.md    .specify/templates/lisa-prompt.template.md

# Claude Code commands → .claude/commands/
cp <path-to-simpsons-loops>/speckit.ralph.implement.md   .claude/commands/speckit.ralph.implement.md
cp <path-to-simpsons-loops>/speckit.lisa.analyze.md      .claude/commands/speckit.lisa.analyze.md
```

### 2. Make scripts executable

```bash
chmod +x .specify/scripts/bash/ralph-loop.sh
chmod +x .specify/scripts/bash/lisa-loop.sh
```

### 3. Update `.gitignore`

Append the entries from the included `gitignore` file to your project's `.gitignore`:

```gitignore
# Simpsons loops - generated at runtime
*.ralph-prompt.md*
*.ralph-prev-output*    # Stuck detection state
*.ralph-state*          # Resumption state

# Lisa loop temp files
*.lisa-prompt.md*
*.lisa-prev-output*
*.lisa-state*

*.specify/logs/*        # All log files
```

### 4. Allow loop scripts in Claude Code permissions

Add the loop scripts to your `.claude/settings.local.json` allow list so Claude Code can run them without prompting:

```json
{
  "permissions": {
    "allow": [
      "Bash(.specify/scripts/bash/ralph-loop.sh*)",
      "Bash(.specify/scripts/bash/lisa-loop.sh*)"
    ]
  }
}
```

## File mapping reference

| Source file                    | Destination                                        | Purpose                        |
| ------------------------------ | -------------------------------------------------- | ------------------------------ |
| `ralph-loop.sh`                | `.specify/scripts/bash/ralph-loop.sh`              | Bash orchestrator for Ralph    |
| `lisa-loop.sh`                 | `.specify/scripts/bash/lisa-loop.sh`               | Bash orchestrator for Lisa     |
| `ralph-prompt.template.md`     | `.specify/templates/ralph-prompt.template.md`      | Prompt template for Ralph      |
| `lisa-prompt.template.md`      | `.specify/templates/lisa-prompt.template.md`       | Prompt template for Lisa       |
| `speckit.ralph.implement.md`   | `.claude/commands/speckit.ralph.implement.md`       | Claude Code slash command      |
| `speckit.lisa.analyze.md`      | `.claude/commands/speckit.lisa.analyze.md`          | Claude Code slash command      |

## Usage

### Ralph Loop (implementation)

Once you have a `tasks.md` generated by `/speckit.tasks`, run the Ralph command inside Claude Code:

```
/speckit.ralph.implement
```

This generates the prompt and prints a bash command to start the loop:

```bash
.specify/scripts/bash/ralph-loop.sh .specify/.ralph-prompt.md <MAX_ITERATIONS> <FEATURE_DIR>/tasks.md
```

Copy and run that command in your terminal. Ralph will iterate — one task per cycle — until all tasks in `tasks.md` are marked `[x]`.

### Lisa Loop (analysis)

Once you have `spec.md`, `plan.md`, and `tasks.md`, run the Lisa command inside Claude Code:

```
/speckit.lisa.analyze
```

This generates the prompt and prints a bash command:

```bash
.specify/scripts/bash/lisa-loop.sh .specify/.lisa-prompt.md 10
```

Copy and run that command in your terminal. Lisa will iterate — one severity level per cycle (CRITICAL > HIGH > MEDIUM > LOW) — until zero findings remain.

## How the loops work

### Fresh context per iteration

Both loops call `claude -p` as a subprocess for each iteration. This means every cycle starts with zero prior context, preventing hallucination drift and context window exhaustion.

### Completion detection

Each loop detects completion via promise tags in the Claude output:

- Ralph: `<promise>ALL_TASKS_COMPLETE</promise>`
- Lisa: `<promise>ALL_FINDINGS_RESOLVED</promise>`

### Stuck detection

If three consecutive iterations produce identical output, the loop aborts automatically to avoid infinite cycling.

### Logging

All iterations are logged to `.specify/logs/` with timestamps:

```
.specify/logs/ralph-20260218-130522.log
.specify/logs/lisa-20260218-220639.log
```

## Customization

### Quality gates (Ralph)

The `speckit.ralph.implement.md` command extracts quality gates and substitutes the `{QUALITY_GATES}` placeholder in the prompt template. Edit the command file to match your project's tooling (e.g., replace `npm run lint` with your linter).

### Max iterations

- Ralph defaults to `incomplete_tasks + 10`
- Lisa defaults to `10` (4 severity levels + buffer)

Override by editing the generated bash command before running it.

## References

- [Speckit Ralph Loop: Fresh Context AI Development](https://dominic-boettger.com/blog/speckit-ralph-loop-fresh-context-ai-development/)
